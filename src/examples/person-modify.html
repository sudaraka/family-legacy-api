<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Family Legacy API - Modify Person Example</title>
</head>
<body>
    <h1>Modify Exsiting Person (user)</h1>

    <p>
        <strong>Sample Persons</strong>
        <ul id="ul_persons"></ul>
    </p>

    <!-- Input form - start -->
    <fieldset>
        <legend>Person Information</legend>

        <label for="id_input">ID</label>
        <input type="text" id="id_input" readonly>
        <br>

        <label for="first_name_input">First Name</label>
        <input type="text" id="first_name_input">
        <br>

        <label for="last_name_input">Last Name</label>
        <input type="text" id="last_name_input">
        <br>

        <label for="email_input">Email Address</label>
        <input type="text" id="email_input">
        <br>

        <label for="password_input">Password</label>
        <input type="password" id="password_input">
        <br>

        <label for="avatar_url_input">Avatar URL</label>
        <input type="text" id="avatar_url_input">
        <br>

        <hr>
        <button type="button" id="btn_update">Update Person</button>
    </fieldset>
    <!-- Input form - end -->

    <textarea id="result" cols="80" rows="24" readonly></textarea>

<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<script>

var API_BASE = 'http://api.ourfamilylegacy.org/';  // Base URL for the API resources

// Capture button click event of the form, gather form input content and submit
// AJAX request to API

$('#btn_update').on('click', function() {  // Button click event
    var person_url = API_BASE + 'persons/' + $('#id_input').val();

    // Create a JavaScript Object from values in the input boxes
    var person_data = {
        id: $('#id_input').val(),
        first_name: $('#first_name_input').val(),
        last_name: $('#last_name_input').val(),
        email: $('#email_input').val(),
        password: $('#password_input').val(),
        avatar: $('#avatar_url_input').val()
    };

    $.ajax({
        url: person_url,  // http://api.ourfamilylegacy.org/persons/<id>
        method: 'PUT',  // Do a HTTP PUT to modify
        contentType: 'application/json',  // Submit object in JSON format
        data: JSON.stringify(person_data)  // Serialize the object we created in to JSON string
    })
    .done(function(result, status, xhr) {
        var existing_record = $('#a_person_' + person_data.id).data('person');

        // API call returned successfully (HTTP 200)
        // No extra information is returned for this operation

        // Update the list with information we have
        $('#a_person_' + person_data.id).text('[' + person_data.id + ']' + person_data.first_name + ' ' + person_data.last_name);

        Object.keys(person_data).forEach(function(field) {
            if(person_data.hasOwnProperty(field)) {
                existing_record[field] = person_data[field];
            }
        });

        $('#a_person_' + person_data.id).data('person', existing_record);

        $('#result').text(xhr.getAllResponseHeaders());
    })
    .fail(function(xhr) {
        // API call returned a failed status

        if(xhr.responseJSON) {
            // Errors handled or generated by API system is returned as a JSON
            //object

            // Summary message
            console.warn('Error:', xhr.responseJSON.error);

            // Details of the error
            console.log('Message:', xhr.responseJSON.message);

            $('#result').text(JSON.stringify(xhr.responseJSON));
        }
        else {
            // Errors handled or generated *out side* the API system is
            // returned as a standard HTTP (HTML or plain text) response

            $('#result').text(JSON.stringify(xhr.responseText));
        }
    })

});

// Populate sample person list
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].forEach(function(person_id) {
    $.get(API_BASE + 'persons/' + person_id).done(function(result) {
        $('#ul_persons').append(
            $('<li>').append(
                $('<a>')
                .attr({
                    id: 'a_person_' + person_id,
                    href: '#'
                })
                .addClass('a_person')
                .data('person', result)
                .text('[' + result.id + ']' + result.first_name + ' ' + result.last_name)
                .on('click', populate_form)
            )
        );
    });
});

// Populate form when Person link is clicked
function populate_form() {
    var person = $(this).data('person');

    $('#id_input').val(person.id);
    $('#first_name_input').val(person.first_name);
    $('#last_name_input').val(person.last_name);
    $('#email_input').val(person.email);
    $('#avatar_input').val(person.avatar);
    $('#password_input').val('');

    return false;
}

</script>

</body>
</html>
