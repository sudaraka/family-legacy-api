<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Family Legacy API - Modify Person Example</title>
</head>
<body>
    <h1>Modify Existing Person (user)</h1>

    <!-- Authentication form - start -->
    <fieldset>
        <legend>Authentication</legend>

        <label for="user_auth">Username: </label>
        <input type="text" id="user_auth">
        <br>

        <label for="password_auth">Password: </label>
        <input type="password" id="password_auth">
        <button type="button" id="btn_auth">Authenticate &amp; Get Token</button>
    </fieldset>
    <!-- Authentication form - end -->

    <!-- Input form - start -->
    <fieldset>
        <legend>Person Information</legend>

        <label>Access Token: </label>
        <small id="token_auth"></small>
        <br>

        <label for="id_input">ID</label>
        <input type="text" id="id_input" readonly>
        <br>

        <label for="password_input">Password</label>
        <input type="password" id="password_input">
        <br>

        <label for="first_name_input">First Name</label>
        <input type="text" id="first_name_input">
        <br>

        <label for="last_name_input">Last Name</label>
        <input type="text" id="last_name_input">
        <br>

        <label for="email_input">Email Address</label>
        <input type="text" id="email_input">
        <br>

        <label for="avatar_url_input">Avatar URL</label>
        <input type="text" id="avatar_url_input">
        <br>

        <hr>
        <button type="button" id="btn_update">Update Person</button>
    </fieldset>
    <!-- Input form - end -->

    <textarea id="result" cols="80" rows="24" readonly></textarea>

<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<script>

//var API_BASE = 'http://api.ourfamilylegacy.org/',  // Base URL for the API resources
var API_BASE = 'http://127.0.0.1:5000/',  // Base URL for the API resources
    ACCESS_TOKEN = '',  // API access token returned by the authentication process
    PUT_URL = '';  // URL returned by authorization

// Capture button click event of the form, gather form input content and submit
// AJAX request to API
$('#btn_update').on('click', function() {  // Button click event
    // Create a JavaScript Object from values in the input boxes
    var person_data = {
        id: $('#id_input').val(),
        first_name: $('#first_name_input').val(),
        last_name: $('#last_name_input').val(),
        email: $('#email_input').val(),
        password: $('#password_input').val(),
        avatar: $('#avatar_url_input').val()
    };

    $.ajax({
        headers: {
            Authorization: 'Basic ' + btoa(ACCESS_TOKEN + ':')
        },
        url: PUT_URL,  // http://api.ourfamilylegacy.org/persons/<id>
        method: 'PUT',  // Do a HTTP PUT to modify
        contentType: 'application/json',  // Submit object in JSON format
        data: JSON.stringify(person_data)  // Serialize the object we created in to JSON string
    })
    .done(function(result, status, xhr) {
        // API call returned successfully (HTTP 200)
        // No extra information is returned for this operation

        $('#result').text(xhr.getAllResponseHeaders());
    })
    .fail(function(xhr) {
        // API call returned a failed status

        if(xhr.responseJSON) {
            // Errors handled or generated by API system is returned as a JSON
            //object

            // Summary message
            console.warn('Error:', xhr.responseJSON.error);

            // Details of the error
            console.log('Message:', xhr.responseJSON.message);

            $('#result').text(JSON.stringify(xhr.responseJSON));
        }
        else {
            // Errors handled or generated *out side* the API system is
            // returned as a standard HTTP (HTML or plain text) response

            $('#result').text(JSON.stringify(xhr.responseText));
        }
    })

});


// Capture button click event of the authentication form, Make HTTP GET request
// to get the person access token
$('#btn_auth').on('click', function() {  // Button click event
    var auth_url = API_BASE + 'auth/person',
        credentials = $('#user_auth').val() + ':' + $('#password_auth').val();

    $.ajax({
        headers: {
            Authorization: 'Basic ' + btoa(credentials)
        },
        url: auth_url  // http://api.ourfamilylegacy.org/persons/<id>
    })
    .done(function(result) {
        // Authentication call returned successfully (HTTP 200)
        // At this point API will return the JSON object with access token in
        // response body

        console.log('Access Token:', result.token);

        console.log('Name:', result.user.first_name + ' ' + result.user.last_name);
        console.log('Email:', result.user.email);
        console.log('Status:', result.user.status);
        console.log('Avatar:', result.user.avatar);
        console.log('Self Url:', result.user._links.self);

        PUT_URL = result.user._links.self;

        ACCESS_TOKEN = result.token;  // Store away for later use

        populate_form(result.user);

        $('#result').text(JSON.stringify(result));
    })
    .fail(function(xhr) {
        // API call returned a failed status

        ACCESS_TOKEN = '';

        if(xhr.responseJSON) {
            // Errors handled or generated by API system is returned as a JSON
            // object

            // Summary message
            console.warn('Error:', xhr.responseJSON.error);

            // Details of the error
            console.log('Message:', xhr.responseJSON.message);

            $('#result').text(JSON.stringify(xhr.responseJSON));
        }
        else {
            // Errors handled or generated *out side* the API system is
            // returned as a standard HTTP (HTML or plain text) response

            $('#result').text(JSON.stringify(xhr.responseText));
        }
    })
    .always(function() {
        // Display current access token
        $('#token_auth').text(ACCESS_TOKEN);
    });

});

// Populate form when Person link is clicked
function populate_form(person) {
    $('#id_input, #first_name_input, #last_name_input, #email_input, #avatar_url_input, #password_input').val('');

    $('#id_input').val(person.id);
    $('#first_name_input').val(person.first_name);
    $('#last_name_input').val(person.last_name);
    $('#email_input').val(person.email);
    $('#avatar_url_input').val(person.avatar);

}

</script>

</body>
</html>
