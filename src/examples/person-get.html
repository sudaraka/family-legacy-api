<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Family Legacy API - Get Person Example</title>
</head>
<body>
    <h1>Get Existing Person (user)</h1>

    <!-- Authentication form - start -->
    <fieldset>
        <legend>Authentication</legend>

        <label for="email_auth">Email Address: </label>
        <input type="text" id="email_auth">
        <br>

        <label for="password_auth">Password: </label>
        <input type="password" id="password_auth">
        <button type="button" id="btn_auth">Authenticate &amp; Get Token</button>
    </fieldset>
    <!-- Authentication form - end -->


    <!-- Input form - start -->
    <fieldset>
        <legend>Query</legend>

        <label>Access Token: </label>
        <small id="token_auth"></small>
        <br>

        <label for="id_input">User ID: </label>
        <input type="text" id="id_input">
        <button type="button" id="btn_get">Get Person</button>
    </fieldset>
    <!-- Input form - end -->

    <textarea id="result" cols="80" rows="24" readonly></textarea>

<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>

<script>

var API_BASE = 'http://api.ourfamilylegacy.org/',  // Base URL for the API resources
    ACCESS_TOKEN = '';  // API access token returned by the authentication process


// Capture button click event of the query form, Make HTTP GET request to get
// the Person record
$('#btn_get').on('click', function() {  // Button click event
    var person_url = API_BASE + 'persons/' + $('#id_input').val();

    $.ajax({
        headers: {
            Authorization: 'Basic ' + btoa(ACCESS_TOKEN + ':')
        },
        url: person_url,  // http://api.ourfamilylegacy.org/persons/<id>
        method: 'GET'  // Do a HTTP GET to fetch record
    })
    .done(function(result) {
        // API call returned successfully (HTTP 200)
        // At this point API will return the JSON object of the requested
        // person in response body

        console.log('Name:', result.first_name + ' ' + result.last_name);
        console.log('Email:', result.email);
        console.log('Status:', result.status);
        console.log('Avatar:', result.avatar);
        console.log('Self Url:', result._links.self);

        $('#result').text(JSON.stringify(result));
    })
    .fail(function(xhr) {
        // API call returned a failed status

        if(xhr.responseJSON) {
            // Errors handled or generated by API system is returned as a JSON
            //object

            // Summary message
            console.warn('Error:', xhr.responseJSON.error);

            // Details of the error
            console.log('Message:', xhr.responseJSON.message);

            $('#result').text(JSON.stringify(xhr.responseJSON));
        }
        else {
            // Errors handled or generated *out side* the API system is
            // returned as a standard HTTP (HTML or plain text) response

            $('#result').text(JSON.stringify(xhr.responseText));
        }
    });

});


// Capture button click event of the authentication form, Make HTTP GET request
// to get the person access token
$('#btn_auth').on('click', function() {  // Button click event
    var auth_url = API_BASE + 'auth/person',
        credentials = $('#email_auth').val() + ':' + $('#password_auth').val();

    $.ajax({
        headers: {
            Authorization: 'Basic ' + btoa(credentials)
        },
        url: auth_url  // http://api.ourfamilylegacy.org/persons/<id>
    })
    .done(function(result) {
        // Authentication call returned successfully (HTTP 200)
        // At this point API will return the JSON object with access token in
        // response body

        console.log('User ID:', result.id);
        console.log('Access Token:', result.token);

        $('#id_input').val(result.id);

        ACCESS_TOKEN = result.token;  // Store away for later use

        $('#result').text(JSON.stringify(result));
    })
    .fail(function(xhr) {
        // API call returned a failed status

        ACCESS_TOKEN = '';

        if(xhr.responseJSON) {
            // Errors handled or generated by API system is returned as a JSON
            // object

            // Summary message
            console.warn('Error:', xhr.responseJSON.error);

            // Details of the error
            console.log('Message:', xhr.responseJSON.message);

            $('#result').text(JSON.stringify(xhr.responseJSON));
        }
        else {
            // Errors handled or generated *out side* the API system is
            // returned as a standard HTTP (HTML or plain text) response

            $('#result').text(JSON.stringify(xhr.responseText));
        }
    })
    .always(function() {
        // Display current access token
        $('#token_auth').text(ACCESS_TOKEN);
    });

});

</script>

</body>
</html>
